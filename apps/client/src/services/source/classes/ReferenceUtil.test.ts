import { ReferenceUtil } from './ReferenceUtil';

describe('ReferenceUtil', () => {
  it('getInitialReferenceMaps', async () => {
    const metadata = {
      atom: {
        _id: '6115ecc3c1383376917d1dda',
        name: 'system__groups',
        label: '部门',
        org: '6115ecc2c1383376917d1db4',
        isGenerated: true,
        isDeleted: false,
        isSystem: true,
        tableName: '6115ecc2c1383376917d1db4_system__groups',
        createdAt: '2021-08-13T03:53:39.641Z',
        updatedAt: '2021-08-13T03:53:39.851Z',
        __v: 0,
      },
      electrons: [
        {
          attachmentOptions: {
            allowedMime: [],
          },
          _id: '6115ecc3c1383376917d1ddb',
          org: '6115ecc2c1383376917d1db4',
          atom: '6115ecc3c1383376917d1dda',
          name: 'owner',
          label: '创建人',
          fieldType: 'Owner',
          isSystem: true,
          isGenerated: true,
          isDeleted: false,
          referenceTo: 'system__users',
          foreignName: 'username',
          isRequired: false,
          priority: 0,
          fieldName: '6115ecc2c1383376917d1db4_6115ecc3c1383376917d1dda_owner',
          fieldIndex: 26,
          options: [],
          createdAt: '2021-08-13T03:53:39.647Z',
          updatedAt: '2021-08-13T03:53:39.842Z',
          __v: 0,
        },
        {
          attachmentOptions: {
            allowedMime: [],
          },
          _id: '6115ecc3c1383376917d1ddc',
          name: 'users',
          label: '用户',
          fieldType: 'ManyToMany',
          isRequired: true,
          referenceTo: 'system__users',
          foreignName: 'username',
          org: '6115ecc2c1383376917d1db4',
          atom: '6115ecc3c1383376917d1dda',
          isGenerated: true,
          isDeleted: false,
          isSystem: true,
          priority: 10,
          fieldName: '6115ecc2c1383376917d1db4_6115ecc3c1383376917d1dda_users',
          fieldIndex: 27,
          options: [],
          createdAt: '2021-08-13T03:53:39.657Z',
          updatedAt: '2021-08-13T03:53:39.843Z',
          __v: 0,
        },
        {
          attachmentOptions: {
            allowedMime: [],
          },
          _id: '6115ecc3c1383376917d1ddd',
          name: 'label',
          label: '部门名称',
          fieldType: 'Text',
          isRequired: true,
          isUnique: true,
          org: '6115ecc2c1383376917d1db4',
          atom: '6115ecc3c1383376917d1dda',
          isGenerated: true,
          isDeleted: false,
          isSystem: true,
          priority: 20,
          fieldName: '6115ecc2c1383376917d1db4_6115ecc3c1383376917d1dda_label',
          fieldIndex: 28,
          options: [],
          createdAt: '2021-08-13T03:53:39.672Z',
          updatedAt: '2021-08-13T03:53:39.846Z',
          __v: 0,
        },
        {
          attachmentOptions: {
            allowedMime: [],
          },
          _id: '6115ecc3c1383376917d1dde',
          name: 'roles',
          label: '角色',
          fieldType: 'ManyToMany',
          isRequired: true,
          referenceTo: 'system__roles',
          foreignName: 'label',
          org: '6115ecc2c1383376917d1db4',
          atom: '6115ecc3c1383376917d1dda',
          isGenerated: true,
          isDeleted: false,
          isSystem: true,
          priority: 30,
          fieldName: '6115ecc2c1383376917d1db4_6115ecc3c1383376917d1dda_roles',
          fieldIndex: 29,
          options: [],
          createdAt: '2021-08-13T03:53:39.681Z',
          updatedAt: '2021-08-13T03:53:39.848Z',
          __v: 0,
        },
        {
          attachmentOptions: {
            allowedMime: [],
          },
          _id: '6115ecc3c1383376917d1ddf',
          name: 'parent',
          label: '父级',
          fieldType: 'ManyToOne',
          referenceTo: 'system__groups',
          foreignName: 'label',
          isRequired: false,
          org: '6115ecc2c1383376917d1db4',
          atom: '6115ecc3c1383376917d1dda',
          isGenerated: true,
          isDeleted: false,
          isSystem: true,
          priority: 40,
          fieldName: '6115ecc2c1383376917d1db4_6115ecc3c1383376917d1dda_parent',
          fieldIndex: 30,
          options: [],
          createdAt: '2021-08-13T03:53:39.687Z',
          updatedAt: '2021-08-13T03:53:39.850Z',
          __v: 0,
        },
      ],
    };

    const referenceUtil = new ReferenceUtil();

    const initialReferenceMaps = referenceUtil.getInitialReferenceMaps(
      metadata as any,
    );

    expect(initialReferenceMaps).toEqual([
      {
        electronName: 'owner',
        referenceTo: 'system__users',
        foreignName: 'username',
        ids: [],
      },
      {
        electronName: 'users',
        referenceTo: 'system__users',
        foreignName: 'username',
        ids: [],
      },
      {
        electronName: 'roles',
        referenceTo: 'system__roles',
        foreignName: 'label',
        ids: [],
      },
      {
        electronName: 'parent',
        referenceTo: 'system__groups',
        foreignName: 'label',
        ids: [],
      },
    ]);
  });
});
